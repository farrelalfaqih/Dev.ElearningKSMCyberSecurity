<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login | E-Learning Cyber Security</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;700;800&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#309255',
            borderlight: '#D9D9D9',
            softgreen: '#EEFBF3',
          },
          fontFamily: {
            lexend: ['Lexend'],
            mont: ['Montserrat'],
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Montserrat', sans-serif; }
  </style>
</head>
<body class="bg-softgreen/60 min-h-screen flex flex-col">

<header class="bg-softgreen/60 border-b border-borderlight">
  <div class="max-w-7xl mx-auto px-4 lg:px-8 py-4">
    <div class="flex items-center justify-between">

      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-2xl border border-borderlight bg-white flex items-center justify-center">
          <img src="image/LogoHeader.png" class="w-11 h-11 rounded-xl" alt="Logo">
        </div>
        <div class="font-lexend leading-tight">
          <div class="text-gray-800 text-2xl font-bold">Cyber</div>
          <div class="text-primary text-2xl font-medium">Security</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-4 font-mont text-base">
        <a href="index.html" class="px-4 py-2 rounded-xl hover:bg-softgreen hover:text-primary">
          Home
        </a>
      </nav>

    </div>
  </div>
</header>

<main class="flex-1 flex items-center justify-center px-4 py-12">

  <section class="w-full max-w-lg bg-white border border-borderlight rounded-3xl shadow-lg p-8">

    <h1 class="font-lexend text-3xl font-bold mb-2 text-gray-900">Masuk ke Akun</h1>
    <p class="text-gray-500 text-sm mb-6">Akses materi & sertifikat E-Learning Cyber Security.</p>

    <div id="alert" class="hidden mb-5 rounded-2xl border px-4 py-3 text-sm"></div>

    <form id="login-form" class="space-y-5">

      <div>
        <label class="text-sm font-medium text-gray-700" for="email">Email</label>
        <input
          id="email"
          type="email"
          name="email"
          required
          class="w-full mt-1 px-4 py-2.5 rounded-xl border border-borderlight focus:ring-2 focus:ring-primary focus:outline-none"
          placeholder="email@example.com"
        />
      </div>

      <div>
        <div class="flex justify-between items-center">
          <label class="text-sm font-medium text-gray-700" for="password">Password</label>
          <a href="forgot-password.html" class="text-xs text-primary font-semibold hover:underline">
            Lupa password?
          </a>
        </div>

        <div class="relative mt-1">
          <input
            id="password"
            type="password"
            name="password"
            required
            class="w-full px-4 py-2.5 pr-12 rounded-xl border border-borderlight
                   focus:ring-2 focus:ring-primary focus:outline-none"
            placeholder="Masukkan password"
          />

          <button
            type="button"
            onclick="togglePassword('password', this)"
            class="absolute inset-y-0 right-3 flex items-center"
            aria-label="Toggle Password"
          >
            <img
              src="image/visiblepassword.png"
              alt="Toggle Password"
              class="w-5 h-5 opacity-80 hover:opacity-100 transition-opacity"
            />
          </button>
        </div>

        <p id="error-text" class="text-sm text-red-600 hidden mt-2"></p>

        <div id="verify-panel" class="hidden mt-3 rounded-2xl border border-yellow-200 bg-yellow-50 p-4">
          <p class="text-sm text-yellow-900">
            ⚠️ Email kamu <span class="font-semibold">belum terverifikasi</span>.
            Silakan cek inbox Gmail (termasuk Spam/Promotions).
          </p>

          <div class="mt-3 flex flex-col items-center justify-center gap-2">
            <button
              id="btn-resend"
              type="button"
              class="inline-flex items-center justify-center px-5 py-2.5 rounded-xl
                     bg-white border border-primary text-primary font-semibold
                     hover:bg-primary hover:text-white transition
                     disabled:opacity-60 disabled:cursor-not-allowed"
            >
              Kirim ulang email verifikasi
            </button>

            <p id="cooldown-text" class="hidden text-xs text-yellow-900">
              Mohon tunggu <span id="cooldown-timer" class="font-semibold">05:00</span> sebelum kirim ulang.
            </p>
          </div>
        </div>
      </div>

      <div class="pt-3">
        <button
          id="login-button"
          type="submit"
          class="w-full bg-primary text-white py-3 rounded-xl font-semibold shadow-md 
                 hover:bg-primary/90 transition disabled:opacity-70 disabled:cursor-not-allowed"
        >
          Masuk
        </button>
      </div>
    </form>

    <div class="flex items-center gap-3 my-6">
      <div class="h-px bg-borderlight flex-1"></div>
      <span class="text-xs text-gray-400 uppercase">atau</span>
      <div class="h-px bg-borderlight flex-1"></div>
    </div>

    <p class="text-center text-sm">
      Belum punya akun?
      <a href="sign-up.html" class="text-primary font-semibold hover:underline">Daftar sekarang</a>
    </p>

  </section>
</main>

<footer class="bg-primary">
  <div class="max-w-7xl mx-auto px-4 py-4">
    <p class="text-center text-white text-sm">
      © 2025 KSM Cyber Security — E-Learning Platform
    </p>
  </div>
</footer>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabaseUrl = "https://zvdyxgmfxgmupezpaaxk.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2ZHl4Z21meGdtdXBlenBhYXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjM3NzksImV4cCI6MjA4MDIzOTc3OX0.I2JRd_EPXhOhvrV3IPijGKuL8jdkF55dGsPGSMN5wEg";

  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const form = document.getElementById("login-form");
  const errorText = document.getElementById("error-text");
  const loginButton = document.getElementById("login-button");
  const alertBox = document.getElementById("alert");
  const verifyPanel = document.getElementById("verify-panel");
  const btnResend = document.getElementById("btn-resend");
  const cooldownText = document.getElementById("cooldown-text");
  const cooldownTimer = document.getElementById("cooldown-timer");

  const COOLDOWN_SECONDS = 300; 
  const COOLDOWN_KEY = "resend_verify_cooldown_until";
  let cooldownInterval = null;

  function showAlert(type, msg) {
    alertBox.classList.remove("hidden");
    const styles = {
      error:  "border-red-200 bg-red-50 text-red-800",
      success:"border-green-200 bg-green-50 text-green-800",
      info:   "border-blue-200 bg-blue-50 text-blue-800",
    };
    alertBox.className = `mb-5 rounded-2xl border px-4 py-3 text-sm ${styles[type] || styles.info}`;
    alertBox.textContent = msg;
  }

  function hideAlert() {
    alertBox.classList.add("hidden");
    alertBox.textContent = "";
  }

  function setLoading(isLoading) {
    loginButton.disabled = isLoading;
    loginButton.textContent = isLoading ? "Memproses..." : "Masuk";
  }

  function isEmailVerified(user) {
    return Boolean(user?.email_confirmed_at);
  }

  function formatMMSS(totalSeconds) {
    const m = Math.floor(totalSeconds / 60);
    const s = totalSeconds % 60;
    return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
  }

  function getCooldownUntil() {
    const v = localStorage.getItem(COOLDOWN_KEY);
    const n = v ? Number(v) : 0;
    return Number.isFinite(n) ? n : 0;
  }

  function stopCooldownUI() {
    if (cooldownInterval) clearInterval(cooldownInterval);
    cooldownInterval = null;
    cooldownText.classList.add("hidden");
    btnResend.disabled = false;
    btnResend.textContent = "Kirim ulang email verifikasi";
  }

  function clearCooldown() {
    localStorage.removeItem(COOLDOWN_KEY);
    stopCooldownUI();
  }

  function startCooldownUI() {
    const until = getCooldownUntil();
    const tick = () => {
      const remain = Math.ceil((until - Date.now()) / 1000);
      if (remain <= 0) {
        clearCooldown();
        return;
      }
      btnResend.disabled = true;
      btnResend.textContent = "Tunggu...";
      cooldownText.classList.remove("hidden");
      cooldownTimer.textContent = formatMMSS(remain);
    };
    tick();
    if (cooldownInterval) clearInterval(cooldownInterval);
    cooldownInterval = setInterval(tick, 1000);
  }

  function setCooldown(seconds) {
    const until = Date.now() + seconds * 1000;
    localStorage.setItem(COOLDOWN_KEY, String(until));
    startCooldownUI();
  }

  if (getCooldownUntil() > Date.now()) {
    startCooldownUI();
  }

  async function resendVerification(email) {
    try {
      hideAlert();
      const until = getCooldownUntil();
      if (until > Date.now()) return;
      setCooldown(COOLDOWN_SECONDS);

      const { error } = await supabase.auth.resend({
        type: "signup",
        email
      });

      if (error) {
        clearCooldown();
        showAlert("error", error.message || "Gagal mengirim ulang verifikasi.");
        return;
      }
      showAlert("success", "Email verifikasi sudah dikirim ulang. Cek Gmail kamu.");
    } catch (e) {
      console.error(e);
      clearCooldown();
      showAlert("error", "Terjadi error saat mengirim ulang verifikasi.");
    }
  }

  async function checkSession() {
    try {
      const { data, error } = await supabase.auth.getSession();
      if (error) return;
      if (data?.session?.user) window.location.href = "index.html";
    } catch (err) {
      console.error("Unexpected session error:", err);
    }
  }
  checkSession();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideAlert();
    verifyPanel.classList.add("hidden");
    errorText.classList.add("hidden");
    errorText.textContent = "";

    const formData = new FormData(form);
    const email = (formData.get("email") ?? "").toString().trim();
    const password = (formData.get("password") ?? "").toString();

    if (!email || !password) {
      errorText.textContent = "Email dan password wajib diisi.";
      errorText.classList.remove("hidden");
      return;
    }

    setLoading(true);

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        const msg = (error.message || "").toLowerCase();
        if (msg.includes("email not confirmed") || msg.includes("not confirmed")) {
          hideAlert();
          verifyPanel.classList.remove("hidden");
          btnResend.onclick = () => resendVerification(email);
          if (getCooldownUntil() > Date.now()) startCooldownUI();
          setLoading(false);
          return;
        }
        errorText.textContent = error.message || "Login gagal.";
        errorText.classList.remove("hidden");
        setLoading(false);
        return;
      }

      const user = data?.user;
      if (user && !isEmailVerified(user)) {
        hideAlert();
        verifyPanel.classList.remove("hidden");
        btnResend.onclick = () => resendVerification(email);
        await supabase.auth.signOut();
        setLoading(false);
        return;
      }
      window.location.href = "index.html";
    } catch (err) {
      console.error("Unexpected login error:", err);
      errorText.textContent = "Terjadi kesalahan jaringan.";
      errorText.classList.remove("hidden");
      setLoading(false);
    }
  });
</script>

<script>
  function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    const icon = btn.querySelector("img");

    if (input.type === "password") {
      // KONDISI: Password sedang tersembunyi. User klik untuk melihat.
      // 1. Ubah input jadi text (terlihat)
      input.type = "text";
      // 2. Ganti ikon jadi 'invisible' (mata coret) sebagai instruksi untuk menyembunyikan lagi
      icon.src = "image/invisiblepassword.png";
    } else {
      // KONDISI: Password sedang terlihat. User klik untuk menyembunyikan.
      // 1. Ubah input balik jadi password (tersembunyi)
      input.type = "password";
      // 2. Ganti ikon jadi 'visible' (mata terbuka) sebagai instruksi untuk melihat lagi
      icon.src = "image/visiblepassword.png";
    }
  }
</script>
</body>
</html>